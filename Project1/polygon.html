<!DOCTYPE html>
<html lang="">
	<head>
		<meta charset="utf-8">
		<title>Draw polygon</title>

		<style>
			body {
				margin: 0;
				padding: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100vh;
				background-color: darkgray;
			}

			canvas {
				border: 3px solid black;
			}

			button {
				left: 50px;
				top: 20px;
				height: 25px;

			}

			.custom-menu {
				display: none;
				z-index: 1000;
				position: absolute;
				overflow: hidden;
				border: 1px solid #CCC;
				white-space: nowrap;
				font-family: sans-serif;
				background: #FFF;
				color: #333;
				border-radius: 5px;
				padding: 0;
			}

			/* Each of the items in the list */

			.custom-menu li {
				padding: 8px 12px;
				cursor: pointer;
				list-style-type: none;
				transition: all .3s ease;
				user-select: none;
			}

			.custom-menu li:hover {
				background-color: #DEF;
			}
		</style>
	</head>

	<body>
		<button></button>
		<canvas id="cnv"></canvas>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="drawLine.js"></script>
		<script src="displacement.js"></script>
		<script src="onClick.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>
		<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>

		<script src="https://swisnl.github.io/jQuery-contextMenu/js/main.js" type="text/javascript"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.js"></script>

		<ul class='custom-menu'>
			<li data-action="first">Delete</li>
			<li data-action="second">Horizontal</li>
			<li data-action="third">Vertical</li>
			<li data-action="distance">Distance</li>
		</ul>

		<script>
			const canvas = document.querySelector('canvas');
			const ctx = canvas.getContext('2d');
			canvas.width = 1000;
			canvas.height = 500;
			const cw = canvas.width;
			const ch = canvas.height;
			const topCanvas = canvas.offsetTop;
			const leftCanvas = canvas.offsetLeft;
			ctx.fillStyle = 'white';
			ctx.fillRect(0, 0, cw, ch);
			var circles = [],
				drag = false,
				mouseX,
				mouseY,
				dragHoldX,
				dragHoldY;
			const pointRadius = 10;
			var endDrowing = false;
			var horizontal = 0,
				vertical = 1;
			var minimumDistance = 10;
			var edgeStatus = [];
			
			console.log("modulo -1 5 " + modulo(-1, 5));
			$(canvas).on("click", canvasOnClick);

			$("button").on("click", function(e) {
				$(canvas).prop('onclick', null).off('click');
				canvas.addEventListener("mousedown", mouseDown, false);


				$("canvas").bind("contextmenu", function(e) {
					return true;
				});
			})

			function drawPolygon() {
				var n = circles.length;
				for (var i = 0; i < n - 1; i++) {
					var red = false;
					if (edgeStatus[i] == horizontal) {
						//circles[i + 1].y = circles[i].y;
						var x1 = (circles[i].x + circles[i + 1].x) / 2;
						var y1 = (circles[i].y + circles[i + 1].y) / 2;
						x1 = parseInt(x1);
						y1 = parseInt(y1);
						drawStatusImages(x1, y1 - 14, horizontal);
					} else if (edgeStatus[i] == vertical) {
						//circles[i + 1].x = circles[i].x;
						var x1 = (circles[i].x + circles[i + 1].x) / 2;
						var y1 = (circles[i].y + circles[i + 1].y) / 2;
						x1 = parseInt(x1);
						y1 = parseInt(y1);
						drawStatusImages(x1 - 20, y1, vertical);
					} else if (edgeStatus[i] >= minimumDistance) {
						red = true;
					}

					drawLine(circles[i].x, circles[i].y, circles[i + 1].x, circles[i + 1].y, red);
				}

				if (endDrowing) {
					var red = false;
					if (edgeStatus[n - 1] == horizontal) {
						//circles[0].y = circles[n - 1].y;
						var x1 = (circles[0].x + circles[n - 1].x) / 2;
						var y1 = (circles[0].y + circles[n - 1].y) / 2;
						x1 = parseInt(x1);
						y1 = parseInt(y1);
						drawStatusImages(x1, y1 - 14, horizontal);
					} else if (edgeStatus[n - 1] == vertical) {
						//circles[0].x = circles[n - 1].x;
						var x1 = (circles[0].x + circles[n - 1].x) / 2;
						var y1 = (circles[0].y + circles[n - 1].y) / 2;
						x1 = parseInt(x1);
						y1 = parseInt(y1);
						drawStatusImages(x1 - 20, y1, vertical);
					} else if (edgeStatus[i] >= minimumDistance) {
						red = true;
					}
					MidpointLine(circles[0].x, circles[0].y, circles[n - 1].x, circles[n - 1].y, red);
				}
			}

			function drawCircles() {
				var i, len = circles.length;
				for (i = 0; i < len; i++) {
					ctx.fillStyle = circles[i].color;
					ctx.beginPath();
					ctx.arc(circles[i].x, circles[i].y, circles[i].r, 0, 2 * Math.PI, false);
					ctx.fill();
				}
			}

			function drawCanvas() {
				ctx.fillStyle = 'white';
				ctx.fillRect(0, 0, cw, ch);
				drawCircles();
				drawPolygon();
			}

			function inCircle(circle, mx, my) {
				if (Math.abs(circle.x - mx) <= pointRadius && Math.abs(circle.y - my) <= pointRadius) {
					return true;
				} else {
					return false;
				}
			}

			function inEdge(x1, y1, x2, y2, x3, y3) {
				var a = (y1 - y2) / (x1 - x2);
				var b = y1 - a * x1;
				if (x3 < Math.max(x1, x2) && x3 > Math.min(x1, x2) && y3 < Math.max(y1, y2) &&
					y3 > Math.min(y1, y2) && Math.abs(y3 - a * x3 - b) <= pointRadius*2) {
					return true;
				} else {
					return false;
				}
			}

			$(document).bind("contextmenu", function(e) {
				// Avoid the real one
				e.preventDefault();
				var bRect = canvas.getBoundingClientRect();
				mouseX = (e.clientX - bRect.left);
				mouseY = (e.clientY - bRect.top);
				// Show contextmenu
				$(".custom-menu").finish().toggle(100).

				// In the right position (the mouse)
				css({
					top: e.pageY + "px",
					left: e.pageX + "px"
				});
			});

			// If the document is clicked somewhere
			$(document).bind("mousedown", function(e) {
				// If the clicked element is not the menu
				if (!$(e.target).parents(".custom-menu").length > 0) {
					// Hide it
					$(".custom-menu").hide(000);
				}
			});


			// If the menu element is clicked
			$(".custom-menu li").click(function(e) {
				// This is the triggered action name
				switch ($(this).attr("data-action")) {
						// A case for each action. Your actions here
					case "first":
						deleteVertic(e);
						return;
					case "second":
						Status(horizontal);
						return;
					case "third":
						Status(vertical);
						return;
					case "distance":
						var distance = prompt("Please enter your name:", "100");
						Status(parseInt(distance));
						return;
				}
				// Hide it AFTER the action was triggered
				$(".custom-menu").hide(100);
			});

			function deleteVertic(e) {

				var i, len = circles.length;

				for (i = 0; i < len; i++) {
					if (inCircle(circles[i], mouseX, mouseY)) {
						circles.splice(i, 1);
						drawCanvas();
						break;
					}
				}
			};

			function Status(s) {
				var i, n = circles.length;
				for (i = 0; i < n - 1; i++) {
					if (inEdge(circles[i].x, circles[i].y, circles[i + 1].x, circles[i + 1].y, mouseX, mouseY)) {
						edgeStatus[i] = s;
						if (s == horizontal) {
							circles[i + 1].y = circles[i].y;
						} else if (s == vertical) {
							circles[i + 1].x = circles[i].x;
						}  else if(s >= minimumDistance) {
							var sub = setDistance(circles[i].x, circles[i].y, circles[i + 1].x, circles[i + 1].y, s);
							circles[i + 1].x -= parseInt(sub.dx);
							circles[i + 1].y -= parseInt(sub.dy);
						}
						break;
					}
				}
				if (inEdge(circles[n - 1].x, circles[n - 1].y, circles[0].x, circles[0].y, mouseX, mouseY)) {
					edgeStatus[n - 1] = s;
					if (s == horizontal) {
						circles[0].y = circles[n - 1].y;
					} else if (s == vertical) {
						circles[0].x = circles[n - 1].x;
					} else if(s >= minimumDistance) {
						var sub = setDistance(circles[n-1].x, circles[n-1].y, circles[0].x, circles[0].y, s);
						circles[0].x -= parseInt(sub.dx);
						circles[0].y -= parseInt(sub.dy);
					}
				}
				repairPolygon((i+1)%n);
				drawCanvas();
				drawPolygon();
			}
			
			function drawStatusImages(x, y, s) {
				var img=new Image();
				img.onload=function() {
					ctx.drawImage(img,x,y,20,20);
				}
				if (s == horizontal) {
					img.src="horizontal.png";
				} else {
					img.src="vertical.png";
				}
			}	

			function setDistance(x1, y1, x2, y2, d) {	
				var dist = Math.sqrt((x1-x2) * (x1-x2) + (y1-y2) * (y1-y2));
				var dx = (1-d/dist) * (x2 - x1);
				var dy = (1-d/dist) * (y2 - y1);
				return {dx:dx, dy:dy};
			}			

		</script>
	</body>
</html>
